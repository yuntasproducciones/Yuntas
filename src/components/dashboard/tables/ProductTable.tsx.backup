import { FaTrash, FaRegEdit } from "react-icons/fa";
import { useEffect, useState } from "react";
import Swal from "sweetalert2";
import Modal from "../../Modal";
import ProductForm from "../../products/ProductForm";
import type Producto from "../../../models/Product";
import { config, getApiUrl } from "../../../../config";

export default function DataTable() {
  const [productos, setProductos] = useState<Producto[]>([]);
  const [isOpen, setIsOpen] = useState(false);
  const [currentProduct, setCurrentProduct] = useState<Producto | undefined>(
    undefined
  );
  const [userPermissions, setUserPermissions] = useState<{
    hasValidRole: boolean;
    hasEnviarPermission: boolean;
    canManageProducts: boolean;
  }>({ hasValidRole: false, hasEnviarPermission: false, canManageProducts: false });
    hasValidRole: boolean;
    hasEnviarPermission: boolean;
    canManageProducts: boolean;
  }>({ hasValidRole: false, hasEnviarPermission: false, canManageProducts: false });

  // Verificar permisos del usuario
  const verificarPermisos = async () => {
    const token = localStorage.getItem("authToken");
    if (!token) return;

    try {
      const userInfoResponse = await fetch(getApiUrl('/api/v1/user'), {
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
        },
      });
      
      if (userInfoResponse.ok) {
        const userInfo = await userInfoResponse.json();
        const userData = userInfo.data || userInfo;
        const roles = userData.roles || userData.role || [];
        const permissions = userData.permissions || [];
        
        const hasValidRole = Array.isArray(roles) 
          ? roles.some(role => ['ADMIN', 'USER'].includes(role.name || role))
          : ['ADMIN', 'USER'].includes(roles.name || roles || '');
        
        const hasEnviarPermission = Array.isArray(permissions)
          ? permissions.some(perm => (perm.name || perm) === 'ENVIAR')
          : (permissions.name || permissions) === 'ENVIAR';
        
        setUserPermissions({
          hasValidRole,
          hasEnviarPermission,
          canManageProducts: hasValidRole && hasEnviarPermission
        });
      }
    } catch (error) {
      console.error('Error verificando permisos:', error);
    }
  };

  const obtenerDatos = async () => {
    const url = getApiUrl(config.endpoints.productos.list);
    const token = localStorage.getItem("authToken");
    
    console.log('üìã Obteniendo lista de productos...');
    console.log(' URL:', url);
    console.log('üîê Token length:', token?.length || 0);
    
    try {
      const respuesta = await fetch(url, {
        method: "GET",
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      
      console.log('üìã List response status:', respuesta.status);
      const responseData = await respuesta.json();
      console.log('üìã List response data:', responseData);
      
      if (respuesta.ok) {
        // Manejar la estructura de respuesta de la API v1
        const productosData = responseData.data || responseData;
        const productos = Array.isArray(productosData) ? productosData : [productosData];
        setProductos(productos);
      } else {
        console.error('‚ùå Error al obtener productos:', responseData);
        // Manejo de errores silencioso para no interferir con la UI
        if (respuesta.status === 401) {
          localStorage.removeItem("authToken");
        }
      }
    } catch (error) {
      console.error('‚ùå Error de conexi√≥n al obtener productos:', error);
    }
  };

  const eliminarProducto = async (id: string | number) => {
    if (!userPermissions.canManageProducts) {
      Swal.fire({
        title: "üö´ Permisos insuficientes",
        html: `
          <p>Para eliminar productos necesitas:</p>
          <ul style="text-align: left; margin-top: 10px;">
            <li> Rol: ADMIN o USER ${userPermissions.hasValidRole ? '(‚úì Tienes)' : '(‚ùå Falta)'}</li>
            <li> Permiso: ENVIAR ${userPermissions.hasEnviarPermission ? '(‚úì Tienes)' : '(‚ùå Falta)'}</li>
          </ul>
          <p style="margin-top: 15px;">Contacta al administrador para obtener los permisos necesarios.</p>
        `,
        icon: "warning",
        confirmButtonText: "Entendido",
      });
      return;
    }

    const url = getApiUrl(config.endpoints.productos.delete(id));
    const token = localStorage.getItem("authToken");
    
    console.log('üóëÔ∏è Eliminando producto ID:', id);
    console.log(' URL delete:', url);
    console.log('üîê Token length:', token?.length || 0);
    
    const confirmacion = await Swal.fire({
      title: "¬øEst√°s seguro?",
      text: "¬°Esta acci√≥n no se puede deshacer!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "S√≠, eliminar",
      cancelButtonText: "Cancelar",
    });

    if (confirmacion.isConfirmed) {
      try {
        const respuesta = await fetch(url, {
          method: "DELETE",
          headers: {
            Accept: "application/json",
            Authorization: `Bearer ${token}`,
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        console.log('üóëÔ∏è Delete response status:', respuesta.status);
        const data = await respuesta.json();
        console.log('üóëÔ∏è Delete response data:', data);

        if (respuesta.ok) {
          Swal.fire("¬°Eliminado!", data.message, "success");
          obtenerDatos();
        } else {
          // Manejo mejorado de errores para eliminaci√≥n
          let errorMessage = data.message || 'Error desconocido al eliminar';
          
          if (respuesta.status === 401) {
            errorMessage = 'üîê Token expirado. Por favor inicia sesi√≥n nuevamente.';
            localStorage.removeItem("authToken");
          } else if (respuesta.status === 403) {
            if (data.message?.includes('roles') || data.error?.includes('roles')) {
              errorMessage = 'üö´ No tienes el rol necesario para eliminar productos.';
            } else if (data.message?.includes('permission') || data.error?.includes('permission')) {
              errorMessage = 'üö´ No tienes el permiso necesario para eliminar productos.';
            } else {
              errorMessage = 'üö´ Acceso denegado. Contacta al administrador.';
            }
          } else if (respuesta.status === 404) {
            errorMessage = '‚ùì El producto no existe o ya fue eliminado.';
          }
          
          Swal.fire("Error", errorMessage, "error");
        }
      } catch (error) {
        console.error('‚ùå Error al eliminar producto:', error);
        Swal.fire("Error", "No se pudo conectar con el servidor.", "error");
      }
    }
  };

  const handleEdit = (producto: Producto) => {
    if (!userPermissions.canManageProducts) {
      Swal.fire({
        title: "üö´ Permisos insuficientes",
        html: `
          <p>Para editar productos necesitas:</p>
          <ul style="text-align: left; margin-top: 10px;">
            <li> Rol: ADMIN o USER ${userPermissions.hasValidRole ? '(‚úì Tienes)' : '(‚ùå Falta)'}</li>
            <li> Permiso: ENVIAR ${userPermissions.hasEnviarPermission ? '(‚úì Tienes)' : '(‚ùå Falta)'}</li>
          </ul>
          <p style="margin-top: 15px;">Contacta al administrador para obtener los permisos necesarios.</p>
        `,
        icon: "warning",
        confirmButtonText: "Entendido",
      });
      return;
    }
    setCurrentProduct(producto);
    setIsOpen(true);
  };

  const handleSubmit = async function (formData: FormData) {
    const urlCreate = getApiUrl(config.endpoints.productos.create);
    const token = localStorage.getItem("token");
    
    // Verificar que el token exista y sea v√°lido
    if (!token) {
      Swal.fire("Error", "No hay token de autenticaci√≥n. Por favor inicia sesi√≥n.", "error");
      return;
    }
    
    // Debug: verificar informaci√≥n del usuario y roles
    console.log('Token exists:', !!token);
    console.log('Token length:', token.length);
    console.log('Token preview:', token.substring(0, 20) + '...');
    
    // Diagn√≥stico completo del usuario actual
    try {
      console.log('=== DIAGN√ìSTICO DE PERMISOS ===');
      const userInfoResponse = await fetch(getApiUrl('/api/v1/user'), {
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
        },
      });
      
      console.log('Response status:', userInfoResponse.status);
      const userInfo = await userInfoResponse.json();
      console.log('üìã User info completa:', JSON.stringify(userInfo, null, 2));
      
      // Extraer roles y permisos de diferentes posibles estructuras
      const userData = userInfo.data || userInfo;
      const roles = userData.roles || userData.role || [];
      const permissions = userData.permissions || [];
      
      console.log('üë§ Usuario ID:', userData.id);
      console.log('üìß Email:', userData.email);
      console.log('üé≠ Roles encontrados:', roles);
      console.log('üîê Permisos encontrados:', permissions);
      
      // Verificar si tiene rol ADMIN o USER
      const hasValidRole = Array.isArray(roles) 
        ? roles.some(role => ['ADMIN', 'USER'].includes(role.name || role))
        : ['ADMIN', 'USER'].includes(roles.name || roles || '');
      
      // Verificar si tiene permiso ENVIAR
      const hasEnviarPermission = Array.isArray(permissions)
        ? permissions.some(perm => (perm.name || perm) === 'ENVIAR')
        : (permissions.name || permissions) === 'ENVIAR';
      
      console.log(' Tiene rol v√°lido (ADMIN/USER):', hasValidRole);
      console.log(' Tiene permiso ENVIAR:', hasEnviarPermission);
      console.log(' Puede crear/editar productos:', hasValidRole && hasEnviarPermission);
      console.log('=== FIN DIAGN√ìSTICO ===');
      
    } catch (e) {
      console.error('‚ùå Error al obtener info del usuario:', e);
    }
    
    console.log('FormData entries:', [...formData.entries()]);
    
    try {
      const url = currentProduct
        ? getApiUrl(config.endpoints.productos.update(currentProduct.id))
        : urlCreate;

      console.log('Making request to:', url);

      // Revertir: API v1 S√ç requiere autenticaci√≥n en este caso
      const respuesta = await fetch(url, {
        method: "POST",
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
          "X-Requested-With": "XMLHttpRequest",
          // No agregar Content-Type para FormData - el browser lo hace autom√°ticamente
        },
        body: formData,
      });
      
      // Debug: log de la respuesta para ver el error espec√≠fico
      console.log('Response status:', respuesta.status);
      console.log('Response headers:', [...respuesta.headers.entries()]);
      
      const result = await respuesta.json();
      console.log('Response data:', result);
      
      if (respuesta.ok) {
        Swal.fire({
          title: `${result.message || 'Producto guardado exitosamente'}`,
          icon: "success",
        });
        setIsOpen(false);
        obtenerDatos();
      } else {
        // Manejar diferentes tipos de errores
        let errorMessage = result.message || 'Error desconocido';
        
        if (respuesta.status === 401) {
          errorMessage = 'üîê Token expirado o inv√°lido. Por favor inicia sesi√≥n nuevamente.';
          // Limpiar token inv√°lido
          localStorage.removeItem("authToken");
        } else if (respuesta.status === 403) {
          // Mensaje m√°s espec√≠fico para permisos
          const is403Role = result.message?.includes('roles') || result.error?.includes('roles');
          const is403Permission = result.message?.includes('permission') || result.error?.includes('permission');
          
          if (is403Role) {
            errorMessage = 'üö´ No tienes el rol necesario (ADMIN o USER) para realizar esta acci√≥n.';
          } else if (is403Permission) {
            errorMessage = 'üö´ No tienes el permiso "ENVIAR" necesario para crear/editar productos.';
          } else {
            errorMessage = 'üö´ Acceso denegado. Verifica tus roles y permisos con el administrador.';
          }
        } else if (respuesta.status === 422) {
          const errores = result.errors || {};
          const mensajesError = Object.values(errores).flat().join(", ");
          errorMessage = `üìù Errores de validaci√≥n: ${mensajesError || result.message}`;
        }
        
        Swal.fire("Error", errorMessage, "error");
      }
    } catch (error) {
      console.error('Error en la petici√≥n:', error);
      Swal.fire({
        title: `Hubo un error al insertar el producto`,
        icon: "error",
      });
    }
  };

  useEffect(() => {
    if (isOpen) {
      // Bloquea el scroll del fondo
      document.body.style.overflow = "hidden";
    } else {
      // Restaura el scroll del fondo
      document.body.style.overflow = "auto";
    }

    // Limpieza por si acaso el componente se desmonta
    return () => {
      document.body.style.overflow = "auto";
    };
  }, [isOpen]);

  useEffect(() => {
    obtenerDatos();
    verificarPermisos();
  }, []);

  return (
    <>
      <div className="flex flex-row gap-4">
        {/* Bot√≥n para abrir el modal */}
        <button
          onClick={() => {
            if (!userPermissions.canManageProducts) {
              Swal.fire({
                title: "üö´ Permisos insuficientes",
                html: `
                  <p>Para gestionar productos necesitas:</p>
                  <ul style="text-align: left; margin-top: 10px;">
                    <li> Rol: ADMIN o USER ${userPermissions.hasValidRole ? '(‚úì Tienes)' : '(‚ùå Falta)'}</li>
                    <li> Permiso: ENVIAR ${userPermissions.hasEnviarPermission ? '(‚úì Tienes)' : '(‚ùå Falta)'}</li>
                  </ul>
                  <p style="margin-top: 15px;">Contacta al administrador para obtener los permisos necesarios.</p>
                `,
                icon: "warning",
                confirmButtonText: "Entendido",
              });
              return;
            }
            setCurrentProduct(undefined); // Reset para modo "a√±adir"
            setIsOpen(true);
          }}
          className={`mt-4 text-white text-lg px-10 py-1.5 rounded-full flex items-center gap-2 transition-colors ${
            userPermissions.canManageProducts 
              ? 'bg-blue-950 hover:bg-blue-800 cursor-pointer' 
              : 'bg-gray-500 hover:bg-gray-600 cursor-not-allowed opacity-75'
          }`}
        >
          A√±adir Producto
          {!userPermissions.canManageProducts && <span className="text-xs ml-2">üîí</span>}
        </button>
      </div>
      {/* Tabla */}
      <table className="w-full border-separate border-spacing-2">
        <thead>
          <tr className="bg-blue-950 text-white">
            <th className="px-4 py-2 rounded-xl">ID</th>
            <th className="px-4 py-2 rounded-xl">NOMBRE</th>
            <th className="px-4 py-2 rounded-xl">SECCION</th>
            <th className="px-4 py-2 rounded-xl">PRECIO</th>
            <th className="px-4 py-2 rounded-xl">ACCI√ìN</th>
          </tr>
        </thead>
        <tbody>
          {productos.map((item, index) => (
            <tr
              key={item.id}
              className={`text-center ${
                index % 2 === 0 ? "bg-gray-100" : "bg-gray-300"
              }`}
            >
              <td className="p-2 font-bold rounded-xl">{item.id}</td>
              <td className="p-2 font-bold rounded-xl">{item.nombreProducto || item.subtitle || item.nombre}</td>
              <td className="p-2 font-bold rounded-xl">{item.section || item.tagline || item.seccion}</td>
              <td className="p-2 font-bold rounded-xl">${item.precioProducto || item.precio}</td>
              <td className="p-2 rounded-xl">
                {/* Contenedor de acciones con √≠conos */}
                <div className="flex justify-center gap-5 rounded-xl">
                  <button
                    onClick={() => handleEdit(item)}
                    className="text-green-600 hover:text-green-800 transition cursor-pointer"
                    title="Confirmar"
                  >
                    <FaRegEdit size={18} />
                  </button>
                  <button
                    onClick={() => eliminarProducto(item.id)}
                    className="text-red-600 hover:text-red-800 transition cursor-pointer"
                    title="Eliminar"
                  >
                    <FaTrash size={18} />
                  </button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>

      <Modal
        isOpen={isOpen}
        onClose={() => {
          setIsOpen(false);
          setCurrentProduct(undefined);
        }}
        title={currentProduct ? "Editar Datos" : "Ingresar Datos"}
        form="eliminentechno3"
        btnText={currentProduct ? "Guardar Cambios" : "A√±adir"}
      >
        {/* Formulario */}
        <ProductForm
          initialData={currentProduct}
          onSubmit={handleSubmit}
          isEditing={!!currentProduct}
        />
      </Modal>
    </>
  );
}
